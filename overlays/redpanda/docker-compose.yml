version: '3.8'

services:
    redpanda:
        image: docker.redpanda.com/redpandadata/redpanda:${REDPANDA_VERSION:-latest}
        restart: unless-stopped
        command:
            - redpanda
            - start
            - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
            - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
            - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
            - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
            - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
            - --rpc-addr redpanda:33145
            - --advertise-rpc-addr redpanda:33145
            - --mode dev-container
            - --smp 1
            - --memory 1G
        volumes:
            - redpanda-data:/var/lib/redpanda/data
        ports:
            - '${REDPANDA_KAFKA_PORT:-9092}:9092'
            - '${REDPANDA_SCHEMA_REGISTRY_PORT:-8081}:8081'
            - '${REDPANDA_PROXY_PORT:-8082}:8082'
            - '${REDPANDA_ADMIN_PORT:-9644}:9644'
        networks:
            - devnet
        healthcheck:
            test: ['CMD-SHELL', "rpk cluster health | grep -q 'Healthy:.*true'"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    redpanda-console:
        image: docker.redpanda.com/redpandadata/console:${REDPANDA_CONSOLE_VERSION:-latest}
        restart: unless-stopped
        entrypoint: /bin/sh
        command: -c "echo \"$$CONSOLE_CONFIG_FILE\" > /tmp/config.yml; /app/console"
        environment:
            CONFIG_FILEPATH: /tmp/config.yml
            CONSOLE_CONFIG_FILE: |
                kafka:
                  brokers: ["redpanda:9092"]
                  schemaRegistry:
                    enabled: true
                    urls: ["http://redpanda:8081"]
                redpanda:
                  adminApi:
                    enabled: true
                    urls: ["http://redpanda:9644"]
                connect:
                  enabled: false
        ports:
            - '${REDPANDA_CONSOLE_PORT:-8080}:8080'
        networks:
            - devnet
        depends_on:
            redpanda:
                condition: service_healthy

volumes:
    redpanda-data:

networks:
    devnet:
