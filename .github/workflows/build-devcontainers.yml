name: Build DevContainers

on:
  push:
    branches:
      - main
    paths:
      - 'templates/**'
      - 'features/**'
      - '.github/workflows/build-devcontainers.yml'
  pull_request:
    paths:
      - 'templates/**'
      - 'features/**'
      - '.github/workflows/build-devcontainers.yml'

jobs:
  detect-changes:
    name: Detect Changed Templates
    runs-on: ubuntu-latest
    outputs:
      dotnet: ${{ steps.filter.outputs.dotnet }}
      fullstack: ${{ steps.filter.outputs.fullstack }}
      node-typescript: ${{ steps.filter.outputs.node-typescript }}
      python-mkdocs: ${{ steps.filter.outputs.python-mkdocs }}
      features: ${{ steps.filter.outputs.features }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            dotnet:
              - 'templates/dotnet/**'
            fullstack:
              - 'templates/fullstack/**'
            node-typescript:
              - 'templates/node-typescript/**'
            python-mkdocs:
              - 'templates/python-mkdocs/**'
            features:
              - 'features/**'

  build-containers:
    name: Build ${{ matrix.template }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.dotnet == 'true' ||
      needs.detect-changes.outputs.fullstack == 'true' ||
      needs.detect-changes.outputs.node-typescript == 'true' ||
      needs.detect-changes.outputs.python-mkdocs == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - template: dotnet
            path: templates/dotnet
            enabled: ${{ needs.detect-changes.outputs.dotnet == 'true' }}
          - template: fullstack
            path: templates/fullstack
            enabled: ${{ needs.detect-changes.outputs.fullstack == 'true' }}
          - template: node-typescript
            path: templates/node-typescript
            enabled: ${{ needs.detect-changes.outputs.node-typescript == 'true' }}
          - template: python-mkdocs
            path: templates/python-mkdocs
            enabled: ${{ needs.detect-changes.outputs.python-mkdocs == 'true' }}

    steps:
      - name: Skip if not changed
        if: matrix.enabled != 'true'
        run: |
          echo "Skipping ${{ matrix.template }} - no changes detected"
          exit 0

      - name: Checkout repository
        if: matrix.enabled == 'true'
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        if: matrix.enabled == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Install DevContainer CLI
        if: matrix.enabled == 'true'
        run: npm install -g @devcontainers/cli

      - name: Build DevContainer - ${{ matrix.template }}
        if: matrix.enabled == 'true'
        run: |
          devcontainer build \
            --workspace-folder ${{ matrix.path }} \
            --image-name devcontainer-${{ matrix.template }}:test
        env:
          DOCKER_BUILDKIT: 1

      - name: Verify container
        if: matrix.enabled == 'true'
        run: |
          echo "Successfully built ${{ matrix.template }} devcontainer"
          docker images | grep devcontainer-${{ matrix.template }} || true

      - name: Cleanup
        if: always() && matrix.enabled == 'true'
        run: |
          docker rmi devcontainer-${{ matrix.template }}:test || true
