name: Publish to npm

on:
    release:
        types: [published]

jobs:
    publish:
        runs-on: ubuntu-latest
        # Only run on tags matching semantic versioning pattern
        if: startsWith(github.ref, 'refs/tags/v')

        permissions:
            contents: read
            id-token: write # Required for npm provenance

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Extract version from tag
              id: version
              run: |
                  # Extract version from tag (remove 'v' prefix)
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Publishing version: $VERSION"

            - name: Validate version format
              run: |
                  VERSION=${{ steps.version.outputs.version }}
                  if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
                    echo "Error: Invalid semantic version format: $VERSION"
                    exit 1
                  fi

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  registry-url: 'https://registry.npmjs.org'

            - name: Install dependencies
              run: npm ci

            - name: Update package.json version
              run: |
                  VERSION=${{ steps.version.outputs.version }}
                  npm version $VERSION --no-git-tag-version
                  echo "Updated package.json to version $VERSION"

            - name: Build
              run: npm run build

            - name: Run tests
              run: npm test

            - name: Verify package contents
              run: |
                  echo "ðŸ“¦ Package contents preview:"
                  npm pack --dry-run

            - name: Publish to npm
              run: npm publish --provenance --access public
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Verify published package
              run: |
                  VERSION=${{ steps.version.outputs.version }}
                  echo "Waiting for npm registry to update..."
                  sleep 10
                  npm view container-superposition@$VERSION version || echo "Package published successfully but not yet visible in registry"
