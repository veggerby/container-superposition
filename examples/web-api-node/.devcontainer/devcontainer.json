{
    "$schema": "https://raw.githubusercontent.com/devcontainers/spec/main/schemas/devContainer.base.schema.json",
    "name": "Compose-Based Development",
    "dockerComposeFile": "docker-compose.yml",
    "service": "devcontainer",
    "workspaceFolder": "/workspaces/${localWorkspaceFolderBasename}",
    "runServices": ["postgres", "redis", "prometheus", "loki", "otel-collector", "grafana"],
    "features": {
        "ghcr.io/devcontainers/features/common-utils:2": {
            "installZsh": true,
            "installOhMyZsh": true,
            "upgradePackages": true,
            "username": "vscode",
            "userUid": "automatic",
            "userGid": "automatic"
        },
        "ghcr.io/devcontainers/features/git:1": {
            "version": "os-provided"
        },
        "./features/cross-distro-packages": {
            "apt": "bash-completion curl wget vim less build-essential redis-tools",
            "apk": "bash-completion curl wget vim less build-base redis"
        },
        "ghcr.io/devcontainers/features/docker-outside-of-docker:1": {
            "moby": false
        },
        "ghcr.io/devcontainers/features/node:1": {
            "version": "lts",
            "nodeGypDependencies": true,
            "installYarnUsingApt": true
        },
        "ghcr.io/robbert229/devcontainer-features/postgresql-client:1": {}
    },
    "customizations": {
        "vscode": {
            "extensions": [
                "EditorConfig.EditorConfig",
                "ms-azuretools.vscode-docker",
                "GitHub.copilot",
                "GitHub.copilot-chat",
                "dbaeumer.vscode-eslint",
                "esbenp.prettier-vscode",
                "christian-kohler.npm-intellisense"
            ],
            "settings": {
                "editor.formatOnSave": true,
                "editor.defaultFormatter": "esbenp.prettier-vscode",
                "editor.codeActionsOnSave": {
                    "source.fixAll.eslint": "explicit"
                },
                "[typescript]": {
                    "editor.defaultFormatter": "esbenp.prettier-vscode"
                },
                "[javascript]": {
                    "editor.defaultFormatter": "esbenp.prettier-vscode"
                }
            }
        }
    },
    "mounts": [],
    "remoteEnv": {
        "LOCAL_WORKSPACE_FOLDER": "${localWorkspaceFolder}",
        "PATH": "${containerEnv:HOME}/.local/share/pnpm:${containerEnv:HOME}/.npm-global/bin:${containerEnv:PATH}",
        "POSTGRES_HOST": "postgres",
        "POSTGRES_PORT": "5432",
        "POSTGRES_DB": "devdb",
        "POSTGRES_USER": "postgres",
        "POSTGRES_PASSWORD": "postgres",
        "REDIS_HOST": "redis",
        "REDIS_PORT": "6379"
    },
    "remoteUser": "vscode",
    "forwardPorts": [9090, 3100, 4317, 4318, 8888, 8889, 13133, 3000, 8080, 5432, 6379],
    "portsAttributes": {
        "3000": {
            "label": "Dev Server",
            "onAutoForward": "openBrowser"
        },
        "3100": {
            "label": "Loki",
            "onAutoForward": "silent"
        },
        "4317": {
            "label": "OTLP gRPC",
            "onAutoForward": "silent"
        },
        "4318": {
            "label": "OTLP HTTP",
            "onAutoForward": "silent"
        },
        "5432": {
            "label": "PostgreSQL",
            "onAutoForward": "notify"
        },
        "6379": {
            "label": "Redis",
            "onAutoForward": "notify"
        },
        "8080": {
            "label": "Web App",
            "onAutoForward": "notify"
        },
        "8888": {
            "label": "Collector Metrics",
            "onAutoForward": "silent"
        },
        "8889": {
            "label": "Prometheus Exporter",
            "onAutoForward": "silent"
        },
        "9090": {
            "label": "Prometheus",
            "onAutoForward": "openBrowser"
        },
        "13133": {
            "label": "Health Check",
            "onAutoForward": "silent"
        }
    },
    "postCreateCommand": {
        "setup-otel-collector": "bash .devcontainer/scripts/setup-otel-collector.sh",
        "setup-nodejs": "bash .devcontainer/scripts/setup-nodejs.sh"
    },
    "postStartCommand": {
        "verify-prometheus": "bash .devcontainer/scripts/verify-prometheus.sh",
        "verify-grafana": "bash .devcontainer/scripts/verify-grafana.sh",
        "verify-nodejs": "bash .devcontainer/scripts/verify-nodejs.sh",
        "verify-postgres": "bash .devcontainer/scripts/verify-postgres.sh",
        "verify-redis": "bash .devcontainer/scripts/verify-redis.sh"
    }
}
